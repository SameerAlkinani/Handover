<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Warehouse Handover Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- XLSX for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --nav:#0c2340;
      --bg:#f4f5f7;
      --card:#ffffff;
      --border:#e1e4eb;
      --muted:#6b7280;
      --accent:#145da0;
    }
    body{background:var(--bg); font-family:system-ui,-apple-system,"Segoe UI",sans-serif;}
    .app-shell{min-height:100vh; display:flex;}
    .sidebar{
      width:260px; background:var(--nav); color:#fff;
      padding:1.5rem 1.25rem; display:flex; flex-direction:column;
    }
    .sidebar-brand{display:flex; gap:.6rem; align-items:center; margin-bottom:1.5rem;}
    .brand-icon{
      width:36px; height:36px; border-radius:10px;
      background:linear-gradient(135deg,#2e86de,#48dbfb);
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
    }
    .sidebar-nav .nav-link{
      color:#cbd5f5; padding:.55rem .75rem; border-radius:.6rem;
      display:flex; gap:.5rem; align-items:center; margin-bottom:.35rem;
    }
    .sidebar-nav .nav-link.active,.sidebar-nav .nav-link:hover{background:rgba(255,255,255,.12); color:#fff;}
    .sidebar-footer{margin-top:auto; color:#9fb3ff; font-size:.8rem;}
    .main-panel{flex:1; padding:1.25rem 1.25rem 2rem; display:flex; flex-direction:column; gap:1rem;}
    .top-bar{display:flex; align-items:center; justify-content:space-between; gap:1rem;}
    .top-title{font-size:1.35rem; font-weight:700;}
    .cards-grid{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:1rem;}
    .stat-card,.panel-card{
      background:var(--card); border:1px solid var(--border);
      border-radius:1rem; padding:1rem;
    }
    .stat-label{font-size:.75rem; letter-spacing:.08em; text-transform:uppercase; color:var(--muted);}
    .stat-value{font-size:1.5rem; font-weight:800;}
    .filters-grid{display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:.75rem; align-items:end;}
    table thead th{
      font-size:.75rem; text-transform:uppercase; letter-spacing:.06em; color:var(--muted);
      background:#f9fafb; position:sticky; top:0; z-index:1; border-bottom-width:1px;
    }
    .table-card--resizable{resize:vertical; overflow:hidden; min-height:240px; max-height:80vh; display:flex; flex-direction:column;}
    .table-card--resizable .table-responsive{flex:1 1 auto; overflow:auto;}
    .status-badge{border-radius:999px; padding:.15rem .75rem; font-size:.75rem; font-weight:600;}
    .status-pending{background:#fff7ed; color:#c05621;}
    .status-inprogress{background:#eff6ff; color:#1d4ed8;}
    .status-completed{background:#ecfdf3; color:#166534;}
    .status-delayed{background:#fef2f2; color:#b91c1c;}
    .view-section{display:block;}
    .view-section.d-none{display:none !important;}

    /* Auth / Setup pages */
    .auth-page{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:1rem;}
    .auth-card{max-width:520px; width:100%; background:#fff; border:1px solid var(--border); border-radius:1rem; padding:1.25rem;}
    .auth-sub{color:var(--muted); font-size:.9rem;}

    @media (max-width: 992px){
      .app-shell{flex-direction:column;}
      .sidebar{width:100%; flex-direction:row; gap:1rem; align-items:center;}
      .sidebar-nav{display:flex; flex-wrap:wrap; gap:.35rem;}
      .cards-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
      .filters-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media (max-width:576px){
      .cards-grid{grid-template-columns:1fr;}
      .filters-grid{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>

<!-- ===== First-run Setup (Create Admin) ===== -->
<div id="setup-page" class="auth-page" style="display:none;">
  <div class="auth-card shadow-sm">
    <div class="d-flex align-items-center gap-2 mb-2">
      <div class="brand-icon">WH</div>
      <div>
        <div class="fw-bold">First time setup</div>
        <div class="auth-sub">Create your Admin account (no default accounts are created).</div>
      </div>
    </div>

    <form id="setup-form" class="mt-3">
      <div class="mb-2">
        <label class="form-label">Admin username</label>
        <input id="setup-username" class="form-control" required />
      </div>
      <div class="mb-2">
        <label class="form-label">Admin password</label>
        <input id="setup-password" type="password" class="form-control" required />
      </div>
      <div class="mb-2">
        <label class="form-label">Linked employee name (optional)</label>
        <input id="setup-employee" class="form-control" placeholder="e.g. Sameer Jabbar" />
        <div class="form-text">You can add employees later. Linking helps auto-fill “From” and “Action By”.</div>
      </div>

      <div id="setup-error" class="text-danger small mt-2" style="display:none;"></div>
      <button class="btn btn-primary w-100 mt-2" type="submit">
        <i class="bi bi-shield-lock"></i> Create Admin
      </button>
    </form>

    <div class="auth-sub mt-3">
      Notes:
      <ul class="mb-0">
        <li>All data is stored in this browser only (prototype).</li>
        <li>Use <b>Export/Import JSON</b> later to move data to another device.</li>
      </ul>
    </div>
  </div>
</div>

<!-- ===== Login ===== -->
<div id="login-page" class="auth-page" style="display:none;">
  <div class="auth-card shadow-sm">
    <div class="d-flex align-items-center gap-2 mb-2">
      <div class="brand-icon">WH</div>
      <div>
        <div class="fw-bold">Warehouse Handover Login</div>
        <div class="auth-sub">Sign in to manage your handovers.</div>
      </div>
    </div>

    <form id="login-form" class="mt-3">
      <div class="mb-2">
        <label class="form-label">Username</label>
        <input type="text" id="login-username" class="form-control" autocomplete="username" required />
      </div>
      <div class="mb-2">
        <label class="form-label">Password</label>
        <input type="password" id="login-password" class="form-control" autocomplete="current-password" required />
      </div>
      <div id="login-error" class="text-danger small mt-2" style="display:none;"></div>
      <button type="submit" class="btn btn-primary w-100 mt-2">
        <i class="bi bi-box-arrow-in-right"></i> Login
      </button>
    </form>
  </div>
</div>

<!-- ===== App ===== -->
<div id="app-shell" class="app-shell" style="display:none;">
  <aside class="sidebar">
    <div>
      <div class="sidebar-brand">
        <div class="brand-icon">WH</div>
        <div>
          <div class="fw-semibold">Warehouse</div>
          <div style="font-size:.75rem;color:#9ca3af">Handover Dashboard</div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="#" class="nav-link active" data-view="dashboard"><i class="bi bi-grid"></i><span>Dashboard</span></a>
        <a href="#" class="nav-link" data-view="handovers"><i class="bi bi-box-seam"></i><span>Handovers</span></a>
        <a href="#" class="nav-link" data-view="deleted-handovers"><i class="bi bi-trash3"></i><span>Deleted</span></a>
        <a href="#" class="nav-link" data-view="employees"><i class="bi bi-buildings"></i><span>Employees</span></a>
        <a href="#" class="nav-link" data-view="admin-users"><i class="bi bi-people"></i><span>Accounts (Admin)</span></a>
        <a href="#" class="nav-link" data-view="reports"><i class="bi bi-bar-chart-line"></i><span>Reports</span></a>
      </nav>
    </div>

    <div class="sidebar-footer">
      <div class="mb-2 small" id="current-user-label"></div>

      <button class="btn btn-sm btn-outline-light w-100 mb-2" id="btn-logout">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>

      <button class="btn btn-sm btn-outline-danger w-100 mb-2" id="btn-wipe-all" title="Admin only">
        <i class="bi bi-exclamation-octagon"></i> Wipe All (Admin)
      </button>

      <div style="font-size:.75rem;">v2.0 – Clean Start (No Defaults)</div>
    </div>
  </aside>

  <main class="main-panel">

    <!-- DASHBOARD -->
    <section class="view-section" data-view="dashboard">
      <div class="top-bar">
        <div>
          <div class="top-title">Warehouse Handover Overview</div>
          <div style="font-size:.9rem;color:var(--muted)">Track and manage handovers in a clean workflow.</div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <div class="d-flex align-items-center gap-1">
            <span style="font-size:.8rem;color:var(--muted)">User:</span>
            <span class="badge bg-light text-dark" id="top-user-badge">—</span>
          </div>

          <button class="btn btn-sm btn-primary" id="btn-add-handover">
            <i class="bi bi-plus-lg"></i> New Handover
          </button>
          <button class="btn btn-sm btn-success" id="btn-export-excel">
            <i class="bi bi-file-earmark-excel"></i> Export Excel
          </button>
        </div>
      </div>

      <section class="cards-grid">
        <div class="stat-card">
          <div class="d-flex justify-content-between align-items-center">
            <span class="stat-label">Visible Handovers</span><i class="bi bi-arrows-move"></i>
          </div>
          <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
          <div class="d-flex justify-content-between align-items-center">
            <span class="stat-label">Pending</span><i class="bi bi-hourglass-split"></i>
          </div>
          <div class="stat-value" id="stat-pending">0</div>
        </div>
        <div class="stat-card">
          <div class="d-flex justify-content-between align-items-center">
            <span class="stat-label">Completed</span><i class="bi bi-check2-circle"></i>
          </div>
          <div class="stat-value text-success" id="stat-completed">0</div>
        </div>
        <div class="stat-card">
          <div class="d-flex justify-content-between align-items-center">
            <span class="stat-label">Delayed</span><i class="bi bi-exclamation-triangle"></i>
          </div>
          <div class="stat-value text-danger" id="stat-delayed">0</div>
        </div>
      </section>

      <section class="panel-card mt-2">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Filters</h6>
          <button class="btn btn-sm btn-link p-0" id="btn-reset-filters">Reset</button>
        </div>

        <div class="filters-grid">
          <div>
            <label class="form-label form-label-sm">From</label>
            <select id="filter-from" class="form-select form-select-sm"><option value="">All</option></select>
          </div>
          <div>
            <label class="form-label form-label-sm">To</label>
            <select id="filter-to" class="form-select form-select-sm"><option value="">All</option></select>
          </div>
          <div>
            <label class="form-label form-label-sm">Status</label>
            <select id="filter-status" class="form-select form-select-sm">
              <option value="">All</option>
              <option>Pending</option>
              <option>In Progress</option>
              <option>Completed</option>
              <option>Delayed</option>
            </select>
          </div>
          <div>
            <label class="form-label form-label-sm">Priority</label>
            <select id="filter-priority" class="form-select form-select-sm">
              <option value="">All</option>
              <option value="P1">P1 - High</option>
              <option value="P2">P2 - Moderate</option>
              <option value="P3">P3 - Low</option>
              <option value="P4">P4 - Negligible</option>
            </select>
          </div>
          <div>
            <label class="form-label form-label-sm">Date From</label>
            <input type="date" id="filter-date-from" class="form-control form-control-sm"/>
          </div>
          <div>
            <label class="form-label form-label-sm">Date To</label>
            <input type="date" id="filter-date-to" class="form-control form-control-sm"/>
          </div>
          <div>
            <label class="form-label form-label-sm">Search</label>
            <input type="text" id="filter-search" class="form-control form-control-sm" placeholder="ID / item / from / to"/>
          </div>
        </div>
      </section>

      <section class="panel-card table-card--resizable mt-2">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Handover List</h6>
          <span id="table-count" style="font-size:.85rem;color:var(--muted)"></span>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th><th>FROM</th><th>TO</th><th>ITEMS</th><th>PRIORITY</th><th>STATUS</th><th>DATE</th><th>ACTION BY</th><th>ATT</th><th style="width:130px">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="handover-tbody"></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- HANDOVERS (Completed) -->
    <section class="view-section d-none" data-view="handovers">
      <div class="top-bar mb-2">
        <div>
          <div class="top-title">Completed Handovers</div>
          <div style="font-size:.9rem;color:var(--muted)">Only completed records within your visibility.</div>
        </div>
        <button class="btn btn-sm btn-primary" id="btn-add-handover-2"><i class="bi bi-plus-lg"></i> New</button>
      </div>

      <div class="panel-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Completed</h6>
          <span id="completed-count" style="font-size:.85rem;color:var(--muted)"></span>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th><th>FROM</th><th>TO</th><th>ITEMS</th><th>PRIORITY</th><th>STATUS</th><th>DATE</th><th>ACTION BY</th><th>ATT</th><th style="width:130px">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="completed-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- DELETED -->
    <section class="view-section d-none" data-view="deleted-handovers">
      <div class="top-bar mb-2">
        <div>
          <div class="top-title">Deleted Handovers</div>
          <div style="font-size:.9rem;color:var(--muted)">Admin can restore deleted items.</div>
        </div>
      </div>

      <div class="panel-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Deleted</h6>
          <span id="deleted-count" style="font-size:.85rem;color:var(--muted)"></span>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th><th>FROM</th><th>TO</th><th>ITEMS</th><th>PRIORITY</th><th>STATUS</th><th>DATE</th><th>ACTION BY</th><th>ATT</th><th style="width:100px">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="deleted-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- EMPLOYEES -->
    <section class="view-section d-none" data-view="employees">
      <div class="top-bar mb-2">
        <div>
          <div class="top-title">Employees</div>
          <div style="font-size:.9rem;color:var(--muted)">Add/edit employees used in From/To/Action By.</div>
        </div>
      </div>

      <div class="panel-card">
        <form id="employee-form" class="row g-2">
          <div class="col-md-4">
            <label class="form-label form-label-sm">Name</label>
            <input id="emp-name" class="form-control" required/>
          </div>
          <div class="col-md-3">
            <label class="form-label form-label-sm">Role/Title</label>
            <input id="emp-role" class="form-control" placeholder="Manager / Supervisor"/>
          </div>
          <div class="col-md-3">
            <label class="form-label form-label-sm">Email</label>
            <input id="emp-email" type="email" class="form-control" placeholder="name@company.com"/>
          </div>
          <div class="col-md-2 d-grid align-self-end">
            <button class="btn btn-primary" type="submit"><i class="bi bi-plus-lg"></i> Add</button>
          </div>
        </form>

        <hr/>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>#</th><th>Name</th><th>Role</th><th>Email</th><th style="width:90px">Actions</th></tr></thead>
            <tbody id="employees-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ACCOUNTS (ADMIN) -->
    <section class="view-section d-none" data-view="admin-users">
      <div class="top-bar mb-2">
        <div>
          <div class="top-title">Accounts (Admin)</div>
          <div style="font-size:.9rem;color:var(--muted)">Create accounts & link them to employees. Admin only.</div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary" id="btn-export-json"><i class="bi bi-download"></i> Export JSON</button>
          <button class="btn btn-sm btn-outline-secondary" id="btn-import-json"><i class="bi bi-upload"></i> Import JSON</button>
          <input type="file" id="import-json-input" accept="application/json" hidden />
          <button class="btn btn-sm btn-primary" id="btn-add-account"><i class="bi bi-plus-lg"></i> Add Account</button>
        </div>
      </div>

      <div class="panel-card">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>#</th><th>Username</th><th>Employee</th><th>Role</th><th>Status</th><th style="width:110px">Actions</th></tr></thead>
            <tbody id="accounts-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section class="view-section d-none" data-view="reports">
      <div class="top-bar mb-2">
        <div>
          <div class="top-title">Reports</div>
          <div style="font-size:.9rem;color:var(--muted)">Analytics based on visible handovers.</div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-3"><div class="stat-card"><div class="stat-label">Total</div><div class="stat-value" id="rep-total">0</div></div></div>
        <div class="col-md-3"><div class="stat-card"><div class="stat-label">Pending</div><div class="stat-value" id="rep-pending">0</div></div></div>
        <div class="col-md-3"><div class="stat-card"><div class="stat-label">Completed</div><div class="stat-value text-success" id="rep-completed">0</div></div></div>
        <div class="col-md-3"><div class="stat-card"><div class="stat-label">Delayed</div><div class="stat-value text-danger" id="rep-delayed">0</div></div></div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-lg-6">
          <div class="panel-card">
            <h6>By Status</h6>
            <canvas id="chart-status" height="220"></canvas>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="panel-card">
            <h6>By Action By</h6>
            <canvas id="chart-user" height="220"></canvas>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- ===== Modals ===== -->

<!-- Handover Modal -->
<div class="modal fade" id="handover-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="handover-form">
        <div class="modal-header">
          <h5 class="modal-title" id="handover-modal-title">New Handover</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Handover ID</label>
            <input id="handover-id" class="form-control" readonly />
          </div>

          <div class="mb-2">
            <label class="form-label">From (Employee)</label>
            <select id="handover-from" class="form-select" required></select>
            <div class="form-text">Auto-filled from logged-in user.</div>
          </div>

          <div class="mb-2">
            <label class="form-label">To (Employee)</label>
            <select id="handover-to" class="form-select" required></select>
          </div>

          <div class="mb-2">
            <label class="form-label">Items</label>
            <input id="handover-items" class="form-control" required placeholder="e.g. 150 cartons of Product X"/>
          </div>

          <div class="mb-2">
            <label class="form-label">Long Description</label>
            <textarea id="handover-long" class="form-control" rows="3" placeholder="Optional notes..."></textarea>
          </div>

          <div class="mb-2">
            <label class="form-label">Priority</label>
            <select id="handover-priority" class="form-select" required>
              <option value="P1">P1 - High</option>
              <option value="P2">P2 - Moderate</option>
              <option value="P3">P3 - Low</option>
              <option value="P4">P4 - Negligible</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">Status</label>
            <select id="handover-status" class="form-select" required>
              <option>Pending</option>
              <option>In Progress</option>
              <option>Completed</option>
              <option>Delayed</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">Date</label>
            <input id="handover-date" type="date" class="form-control" required />
          </div>

          <div class="mb-2">
            <label class="form-label">Action By</label>
            <select id="handover-actionby" class="form-select" required></select>
            <div class="form-text">Auto-filled from logged-in user.</div>
          </div>

          <div class="mb-2">
            <label class="form-label">Attachment (optional)</label>
            <div id="attachment-info" class="small text-muted mb-1">No attachment</div>
            <input id="handover-attachment" type="file" class="form-control"/>
            <div class="form-text">Stored as DataURL (browser storage). Keep files small.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="handover-save-btn" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Employee edit Modal -->
<div class="modal fade" id="employee-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="employee-edit-form">
        <div class="modal-header">
          <h5 class="modal-title">Edit Employee</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Name</label>
            <input id="emp-edit-name" class="form-control" required />
          </div>
          <div class="mb-2">
            <label class="form-label">Role/Title</label>
            <input id="emp-edit-role" class="form-control" />
          </div>
          <div class="mb-2">
            <label class="form-label">Email</label>
            <input id="emp-edit-email" type="email" class="form-control" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Account Modal -->
<div class="modal fade" id="account-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="account-form">
        <div class="modal-header">
          <h5 class="modal-title">Account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Username</label>
            <input id="acc-username" class="form-control" required />
          </div>

          <div class="mb-2">
            <label class="form-label">Linked Employee</label>
            <select id="acc-employee" class="form-select">
              <option value="">(No linked employee)</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">Role</label>
            <select id="acc-role" class="form-select">
              <option>Admin</option>
              <option>Supervisor</option>
              <option>User</option>
              <option>Viewer</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">Status</label>
            <select id="acc-status" class="form-select">
              <option value="Active">Active</option>
              <option value="Disabled">Disabled</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">Password (Admin only)</label>
            <input id="acc-password" type="password" class="form-control" placeholder="Leave blank to keep current"/>
            <div class="form-text">Passwords are stored locally in this browser (prototype).</div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
(() => {
  // ===== Constants / Storage Keys =====
  const STORE = {
    employees: "wh.employees.v2",
    accounts:  "wh.accounts.v2",
    handovers: "wh.handovers.v2",
    deleted:   "wh.deleted.v2",
    session:   "wh.session.v2",
    idSerial:  "wh.idserial.v2"
  };

  const MAX_ATTACHMENT_SIZE = 3 * 1024 * 1024;

  // ===== DOM Helpers =====
  const byId = (id) => document.getElementById(id);
  const onId = (id, evt, fn) => { const el = byId(id); if (!el) return false; el.addEventListener(evt, fn); return true; };
  const nowDateISO = () => new Date().toISOString().slice(0,10);

  // ===== In-memory State =====
  let employees = [];
  let accounts  = [];
  let handovers = [];
  let deleted   = [];

  let filtered  = [];
  let charts = { status: null, user: null };

  // Modals
  let modals = { handover:null, employee:null, account:null };

  // Editing state
  let edit = {
    handover: { mode:false, id:null, readOnly:false },
    employeeIndex: null,
    account: { mode:false, index:null }
  };

  // ===== Storage =====
  function loadJson(key, fallback){
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    try { return JSON.parse(raw); } catch { return fallback; }
  }
  function saveJson(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  function loadAll(){
    employees = loadJson(STORE.employees, []);
    accounts  = loadJson(STORE.accounts,  []);
    handovers = loadJson(STORE.handovers, []);
    deleted   = loadJson(STORE.deleted,   []);
  }
  function saveAll(){
    saveJson(STORE.employees, employees);
    saveJson(STORE.accounts,  accounts);
    saveJson(STORE.handovers, handovers);
    saveJson(STORE.deleted,   deleted);
  }

  // ===== Session / Auth =====
  function getSession(){ return loadJson(STORE.session, { username:"" }); }
  function setSession(username){ saveJson(STORE.session, { username: username || "" }); }
  function getLoggedInAccount(){
    const u = (getSession().username || "").trim();
    if (!u) return null;
    return accounts.find(a => a.username === u) || null;
  }

  function validateLogin(username, password){
    const acc = accounts.find(a => a.username === username);
    if (!acc) return { ok:false, message:"Invalid username or password." };
    if ((acc.status || "Active") === "Disabled") return { ok:false, message:"This account is disabled." };
    if ((acc.password || "") !== password) return { ok:false, message:"Invalid username or password." };
    return { ok:true, account: acc };
  }

  // ===== Visibility rules =====
  function visibleHandovers(){
    const acc = getLoggedInAccount();
    if (!acc) return [];

    if (acc.role === "Admin" || acc.role === "Supervisor") return handovers;

    const emp = (acc.employeeName || "").trim();
    if (!emp) return [];

    // ✅ User/Viewer يرى ما يخصه كـ ActionBy أو To
    return handovers.filter(h => (h.actionBy||"").trim() === emp || (h.to||"").trim() === emp);
  }

  function canEditHandover(h){
    const acc = getLoggedInAccount();
    if (!acc) return false;
    if (acc.role === "Admin" || acc.role === "Supervisor") return true;

    const emp = (acc.employeeName || "").trim();
    if (!emp) return false;

    // User: يقدر يعدل ما يخصه (ActionBy) أو ما موجه له (To)
    if (acc.role === "User") return h.actionBy === emp || h.to === emp;

    // Viewer: read-only
    return false;
  }

  // ===== ID Generation =====
  function loadSerial(){
    const n = parseInt(localStorage.getItem(STORE.idSerial) || "0", 10);
    return isNaN(n) ? 0 : n;
  }
  function saveSerial(n){ localStorage.setItem(STORE.idSerial, String(n || 0)); }

  function nextHandoverId(dateISO){
    const d = dateISO ? new Date(dateISO) : new Date();
    const yy = String(d.getFullYear()).slice(-2);
    const mm = String(d.getMonth()+1).padStart(2,"0");
    let s = loadSerial() + 1;
    saveSerial(s);
    return `HNDR-${yy}-${mm}-${String(s).padStart(4,"0")}`;
  }

  // ===== UI: page switching =====
  function showSetup(){
    byId("setup-page").style.display = "flex";
    byId("login-page").style.display = "none";
    byId("app-shell").style.display = "none";
  }
  function showLogin(){
    byId("setup-page").style.display = "none";
    byId("login-page").style.display = "flex";
    byId("app-shell").style.display = "none";
  }
  function showApp(){
    byId("setup-page").style.display = "none";
    byId("login-page").style.display = "none";
    byId("app-shell").style.display = "flex";
  }

  function setActiveView(view){
    const acc = getLoggedInAccount();

    // Admin guard
    if ((view === "admin-users" || view === "deleted-handovers") && (!acc || acc.role !== "Admin")){
      alert("Only Admin can access this section.");
      return;
    }

    document.querySelectorAll(".sidebar-nav .nav-link").forEach(a=>{
      a.classList.toggle("active", a.getAttribute("data-view") === view);
    });
    document.querySelectorAll(".view-section").forEach(s=>{
      s.classList.toggle("d-none", s.getAttribute("data-view") !== view);
    });
  }

  // ===== UI: options fill =====
  function setSelectOptions(selectEl, items, includeAll){
    if (!selectEl) return;
    const cur = selectEl.value;
    selectEl.innerHTML = "";
    if (includeAll){
      const o = document.createElement("option");
      o.value = "";
      o.textContent = "All";
      selectEl.appendChild(o);
    }
    items.forEach(v=>{
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      selectEl.appendChild(o);
    });
    if (cur && items.includes(cur)) selectEl.value = cur;
  }

  function employeeNames(){ return employees.map(e => e.name); }

  function refreshEmployeeSelects(){
    const names = employeeNames();
    setSelectOptions(byId("filter-from"), names, true);
    setSelectOptions(byId("filter-to"), names, true);

    setSelectOptions(byId("handover-to"), names, false);
    setSelectOptions(byId("handover-actionby"), names, false);

    // Account modal employee list
    const accEmp = byId("acc-employee");
    if (accEmp){
      const cur = accEmp.value;
      accEmp.innerHTML = `<option value="">(No linked employee)</option>`;
      names.forEach(n=>{
        const o = document.createElement("option");
        o.value = n; o.textContent = n;
        accEmp.appendChild(o);
      });
      if (cur && names.includes(cur)) accEmp.value = cur;
    }
  }

  // ===== UI: top labels =====
  function updateUserBadges(){
    const acc = getLoggedInAccount();
    const text = acc ? `${acc.username} (${acc.role})` : "—";
    const emp  = acc?.employeeName ? ` • ${acc.employeeName}` : "";
    byId("current-user-label").textContent = acc ? `Logged in as: ${text}${emp}` : "Not logged in";
    byId("top-user-badge").textContent = acc ? `${text}${emp}` : "—";
  }

  // ===== Status Badge =====
  function statusClass(s){
    if (s === "Pending") return "status-badge status-pending";
    if (s === "In Progress") return "status-badge status-inprogress";
    if (s === "Completed") return "status-badge status-completed";
    if (s === "Delayed") return "status-badge status-delayed";
    return "status-badge";
  }

  // ===== Render: tables =====
  function applyFilters(){
    const base = visibleHandovers();

    const fFrom = byId("filter-from").value || "";
    const fTo   = byId("filter-to").value || "";
    const fSt   = byId("filter-status").value || "";
    const fPr   = byId("filter-priority").value || "";
    const dFrom = byId("filter-date-from").value || "";
    const dTo   = byId("filter-date-to").value || "";
    const q     = (byId("filter-search").value || "").toLowerCase().trim();

    filtered = base.filter(h=>{
      if (fFrom && h.from !== fFrom) return false;
      if (fTo   && h.to   !== fTo)   return false;
      if (fSt   && h.status !== fSt) return false;
      if (fPr   && h.priority !== fPr) return false;
      if (dFrom && (h.date||"") < dFrom) return false;
      if (dTo   && (h.date||"") > dTo) return false;

      if (q){
        const text = `${h.id} ${h.items} ${h.from} ${h.to} ${h.actionBy}`.toLowerCase();
        if (!text.includes(q)) return false;
      }
      return true;
    });

    renderMainTable();
  }

  function resetFilters(){
    ["filter-from","filter-to","filter-status","filter-priority","filter-date-from","filter-date-to","filter-search"]
      .forEach(id => { const el = byId(id); if (el) el.value = ""; });
    applyFilters();
  }

  function renderMainTable(){
    const tbody = byId("handover-tbody");
    tbody.innerHTML = "";

    const acc = getLoggedInAccount();
    const isAdmin = acc?.role === "Admin";
    const emp = (acc?.employeeName || "").trim();

    filtered.forEach(h=>{
      const canEdit = canEditHandover(h);
      const linkUrl = h.attachmentDataUrl || null;

      let actions = `
        <button class="btn btn-sm btn-outline-secondary btn-view" data-id="${h.id}" title="${canEdit ? "View / Edit" : "View"}">
          <i class="bi bi-eye"></i>
        </button>
      `;
      if (canEdit){
        actions += `
          <button class="btn btn-sm btn-outline-success btn-complete" data-id="${h.id}" title="Mark Completed">
            <i class="bi bi-check2"></i>
          </button>
        `;
      }
      if (isAdmin){
        actions += `
          <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${h.id}" title="Delete">
            <i class="bi bi-trash"></i>
          </button>
        `;
      }

      const assignedToMe = emp && ((h.to||"") === emp || (h.actionBy||"") === emp);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="fw-semibold">${h.id}</td>
        <td>${h.from}</td>
        <td>${h.to}</td>
        <td>${h.items}</td>
        <td>${h.priority || "-"}</td>
        <td><span class="${statusClass(h.status)}">${h.status}</span></td>
        <td>${h.date || ""}</td>
        <td>
          ${h.actionBy || ""}
          ${assignedToMe ? `<span class="badge bg-primary-subtle text-primary ms-1">Assigned</span>` : ""}
        </td>
        <td>
          ${
            linkUrl
              ? `<a class="btn btn-sm btn-outline-primary" href="${linkUrl}" target="_blank" ${h.attachmentName ? `download="${h.attachmentName}"` : ""}>
                   <i class="bi bi-paperclip"></i>
                 </a>`
              : `<span class="text-muted" style="font-size:.85rem;">None</span>`
          }
        </td>
        <td>${actions}</td>
      `;
      tbody.appendChild(tr);
    });

    byId("table-count").textContent = `${filtered.length} records`;

    attachRowActions();
    renderCompletedTable();
    renderDeletedTable();
    updateStats();
    renderReports();
  }

  function renderCompletedTable(){
    const tbody = byId("completed-tbody");
    tbody.innerHTML = "";

    const base = visibleHandovers().filter(h => h.status === "Completed");
    byId("completed-count").textContent = `${base.length} records`;

    const acc = getLoggedInAccount();
    const isAdmin = acc?.role === "Admin";

    base.forEach(h=>{
      const linkUrl = h.attachmentDataUrl || null;
      const canEdit = canEditHandover(h);

      let actions = `
        <button class="btn btn-sm btn-outline-secondary btn-view" data-id="${h.id}"><i class="bi bi-eye"></i></button>
      `;
      if (isAdmin){
        actions += `
          <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${h.id}"><i class="bi bi-trash"></i></button>
        `;
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="fw-semibold">${h.id}</td>
        <td>${h.from}</td>
        <td>${h.to}</td>
        <td>${h.items}</td>
        <td>${h.priority || "-"}</td>
        <td><span class="${statusClass(h.status)}">${h.status}</span></td>
        <td>${h.date || ""}</td>
        <td>${h.actionBy || ""}</td>
        <td>${linkUrl ? `<a class="btn btn-sm btn-outline-primary" href="${linkUrl}" target="_blank"><i class="bi bi-paperclip"></i></a>` : `<span class="text-muted" style="font-size:.85rem;">None</span>`}</td>
        <td>${actions}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderDeletedTable(){
    const tbody = byId("deleted-tbody");
    tbody.innerHTML = "";

    byId("deleted-count").textContent = `${deleted.length} records`;

    const acc = getLoggedInAccount();
    const isAdmin = acc?.role === "Admin";

    deleted.forEach(h=>{
      const linkUrl = h.attachmentDataUrl || null;

      const actions = isAdmin ? `
        <button class="btn btn-sm btn-outline-success btn-restore" data-id="${h.id}" title="Restore">
          <i class="bi bi-arrow-counterclockwise"></i>
        </button>
      ` : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="fw-semibold">${h.id}</td>
        <td>${h.from}</td>
        <td>${h.to}</td>
        <td>${h.items}</td>
        <td>${h.priority || "-"}</td>
        <td><span class="${statusClass(h.status)}">${h.status}</span></td>
        <td>${h.date || ""}</td>
        <td>${h.actionBy || ""}</td>
        <td>${linkUrl ? `<a class="btn btn-sm btn-outline-primary" href="${linkUrl}" target="_blank"><i class="bi bi-paperclip"></i></a>` : `<span class="text-muted" style="font-size:.85rem;">None</span>`}</td>
        <td>${actions}</td>
      `;
      tbody.appendChild(tr);
    });

    document.querySelectorAll(".btn-restore").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const acc = getLoggedInAccount();
        if (!acc || acc.role !== "Admin") return alert("Admin only.");
        const id = btn.getAttribute("data-id");
        const idx = deleted.findIndex(x => x.id === id);
        if (idx < 0) return;
        const ok = confirm(`Restore "${id}" ?`);
        if (!ok) return;
        const h = deleted.splice(idx,1)[0];
        handovers.push(h);
        saveAll();
        applyFilters();
      });
    });
  }

  function attachRowActions(){
    document.querySelectorAll(".btn-view").forEach(btn=>{
      btn.addEventListener("click", ()=> openHandover(btn.getAttribute("data-id")));
    });

    document.querySelectorAll(".btn-complete").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        const h = handovers.find(x => x.id === id);
        if (!h) return;
        if (!canEditHandover(h)) return alert("Not allowed.");
        h.status = "Completed";
        saveAll();
        applyFilters();
      });
    });

    document.querySelectorAll(".btn-delete").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const acc = getLoggedInAccount();
        if (!acc || acc.role !== "Admin") return alert("Admin only.");
        const id = btn.getAttribute("data-id");
        const idx = handovers.findIndex(x => x.id === id);
        if (idx < 0) return;
        const ok = confirm(`Delete "${id}" ?`);
        if (!ok) return;
        const h = handovers.splice(idx,1)[0];
        deleted.push(h);
        saveAll();
        applyFilters();
      });
    });
  }

  // ===== Stats / Reports =====
  function updateStats(){
    const total = filtered.length;
    const pending = filtered.filter(h=>h.status==="Pending").length;
    const completed = filtered.filter(h=>h.status==="Completed").length;
    const delayed = filtered.filter(h=>h.status==="Delayed").length;

    byId("stat-total").textContent = total;
    byId("stat-pending").textContent = pending;
    byId("stat-completed").textContent = completed;
    byId("stat-delayed").textContent = delayed;
  }

  function renderReports(){
    const base = visibleHandovers();
    const total = base.length;
    const pending = base.filter(h=>h.status==="Pending").length;
    const completed = base.filter(h=>h.status==="Completed").length;
    const delayed = base.filter(h=>h.status==="Delayed").length;
    const inprog = base.filter(h=>h.status==="In Progress").length;

    byId("rep-total").textContent = total;
    byId("rep-pending").textContent = pending;
    byId("rep-completed").textContent = completed;
    byId("rep-delayed").textContent = delayed;

    const c1 = byId("chart-status");
    const c2 = byId("chart-user");
    if (!c1 || !c2) return;

    if (charts.status) charts.status.destroy();
    charts.status = new Chart(c1.getContext("2d"), {
      type:"bar",
      data:{ labels:["Pending","In Progress","Completed","Delayed"], datasets:[{ label:"Handovers", data:[pending,inprog,completed,delayed] }] },
      options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 } } } }
    });

    const byUser = {};
    base.forEach(h=>{
      const k = h.actionBy || "Unknown";
      byUser[k] = (byUser[k]||0) + 1;
    });

    if (charts.user) charts.user.destroy();
    charts.user = new Chart(c2.getContext("2d"), {
      type:"bar",
      data:{ labels:Object.keys(byUser), datasets:[{ label:"Handovers", data:Object.values(byUser) }] },
      options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 } } } }
    });
  }

  // ===== Excel Export =====
  function exportExcel(){
    const data = (filtered.length ? filtered : visibleHandovers()).map(h=>({
      "ID": h.id,
      "From": h.from,
      "To": h.to,
      "Items": h.items,
      "Long Description": h.longDescription || "",
      "Priority": h.priority || "",
      "Status": h.status || "",
      "Date": h.date || "",
      "Action By": h.actionBy || "",
      "Attachment Name": h.attachmentName || "None",
      "Attachment Link": h.attachmentDataUrl || ""
    }));

    if (!data.length) return alert("No records to export.");
    if (typeof XLSX === "undefined") return alert("XLSX is not loaded.");

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Handovers");
    XLSX.writeFile(wb, "handover_list.xlsx");
  }

  // ===== Attachments =====
  function readFileAsDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // ===== Handover Modal Logic =====
  function initHandoverModal(){
    modals.handover = new bootstrap.Modal(byId("handover-modal"));

    const form = byId("handover-form");
    const titleEl = byId("handover-modal-title");

    const fId = byId("handover-id");
    const fFrom = byId("handover-from");
    const fTo = byId("handover-to");
    const fItems = byId("handover-items");
    const fLong = byId("handover-long");
    const fPr = byId("handover-priority");
    const fSt = byId("handover-status");
    const fDate = byId("handover-date");
    const fAction = byId("handover-actionby");
    const fAtt = byId("handover-attachment");
    const attInfo = byId("attachment-info");
    const saveBtn = byId("handover-save-btn");

    function setReadOnly(ro){
      [fTo,fItems,fLong,fPr,fSt,fDate,fAtt].forEach(el=>{
        if (!el) return;
        ro ? el.setAttribute("disabled","disabled") : el.removeAttribute("disabled");
      });
      // From/ActionBy always locked to logged-in employee for new/edit (unless Admin/Supervisor editing can change to/from? we keep From locked always)
      fFrom.setAttribute("disabled","disabled");
      fAction.setAttribute("disabled","disabled");
      saveBtn.style.display = ro ? "none" : "inline-block";
    }

    function fillFromActionForLoggedIn(){
      const acc = getLoggedInAccount();
      const emp = (acc?.employeeName || "").trim();

      // Must exist as employee name, otherwise still show option
      fFrom.innerHTML = "";
      fAction.innerHTML = "";

      if (emp){
        const o1 = document.createElement("option"); o1.value = emp; o1.textContent = emp;
        const o2 = document.createElement("option"); o2.value = emp; o2.textContent = emp;
        fFrom.appendChild(o1); fAction.appendChild(o2);
        fFrom.value = emp; fAction.value = emp;
      } else {
        // No linked employee => fallback to first employee or empty
        const names = employeeNames();
        const name = names[0] || "";
        if (name){
          fFrom.appendChild(new Option(name,name));
          fAction.appendChild(new Option(name,name));
          fFrom.value = name; fAction.value = name;
        } else {
          fFrom.appendChild(new Option("(No employee linked)",""));
          fAction.appendChild(new Option("(No employee linked)",""));
        }
      }
    }

    function openNew(){
      const acc = getLoggedInAccount();
      if (!acc) return alert("You must be logged in.");
      if ((acc.status||"Active")==="Disabled") return alert("Account disabled.");
      if (acc.role === "Viewer") return alert("Viewer cannot create handovers.");
      if (!employees.length) return alert("Please add employees first (Employees page).");
      if (!acc.employeeName) return alert("Please link this account to an employee (Accounts page).");

      edit.handover = { mode:false, id:null, readOnly:false };

      form.reset();
      refreshEmployeeSelects();

      fDate.value = nowDateISO();
      fId.value = nextHandoverId(fDate.value);

      fillFromActionForLoggedIn();
      fFrom.setAttribute("disabled","disabled");
      fAction.setAttribute("disabled","disabled");

      // default to first employee not equal from
      const fromName = fFrom.value;
      const names = employeeNames().filter(n=>n !== fromName);
      setSelectOptions(fTo, names.length ? names : employeeNames(), false);
      fTo.value = (names[0] || employeeNames()[0] || "");

      fPr.value = "P3";
      fSt.value = "Pending";
      attInfo.textContent = "No attachment";
      fAtt.value = "";

      titleEl.textContent = "New Handover";
      setReadOnly(false);
      modals.handover.show();
    }

    async function saveSubmit(e){
      e.preventDefault();
      if (edit.handover.readOnly) return;

      const acc = getLoggedInAccount();
      if (!acc) return alert("Not logged in.");
      if ((acc.status||"Active")==="Disabled") return alert("Account disabled.");

      // required: must be linked
      const emp = (acc.employeeName || "").trim();
      if (!emp) return alert("This account is not linked to an employee (Accounts page).");

      const payload = {
        id: edit.handover.mode ? edit.handover.id : fId.value,
        from: emp,                // ✅ ALWAYS logged-in employee
        to: (fTo.value||"").trim(),
        items: (fItems.value||"").trim(),
        longDescription: (fLong.value||"").trim(),
        priority: fPr.value,
        status: fSt.value,
        date: fDate.value,
        actionBy: emp,            // ✅ ALWAYS logged-in employee
        attachmentName: null,
        attachmentType: null,
        attachmentSize: null,
        attachmentDataUrl: null
      };

      // Editing: preserve existing attachment if no new file
      if (edit.handover.mode){
        const cur = handovers.find(h=>h.id===edit.handover.id);
        if (!cur) return;
        if (!canEditHandover(cur)) return alert("Not allowed.");
        payload.attachmentName = cur.attachmentName || null;
        payload.attachmentType = cur.attachmentType || null;
        payload.attachmentSize = cur.attachmentSize || null;
        payload.attachmentDataUrl = cur.attachmentDataUrl || null;
      }

      const file = fAtt.files[0] || null;
      if (file){
        if (file.size > MAX_ATTACHMENT_SIZE) return alert("Attachment too large (max ~3MB).");
        payload.attachmentName = file.name;
        payload.attachmentType = file.type || null;
        payload.attachmentSize = file.size;
        payload.attachmentDataUrl = await readFileAsDataUrl(file);
      }

      // Save to list
      if (edit.handover.mode){
        const idx = handovers.findIndex(h=>h.id===edit.handover.id);
        if (idx < 0) return;
        handovers[idx] = { ...handovers[idx], ...payload };
      } else {
        handovers.push(payload);
      }

      saveAll();
      applyFilters();
      modals.handover.hide();
    }

    function openEdit(id){
      const h = handovers.find(x=>x.id===id);
      if (!h) return;

      edit.handover.mode = true;
      edit.handover.id = id;

      refreshEmployeeSelects();

      // Fill fields
      fId.value = h.id;
      fItems.value = h.items || "";
      fLong.value = h.longDescription || "";
      fPr.value = h.priority || "P3";
      fSt.value = h.status || "Pending";
      fDate.value = h.date || nowDateISO();

      // From/ActionBy locked (by design)
      fFrom.innerHTML = "";
      fAction.innerHTML = "";
      fFrom.appendChild(new Option(h.from || "", h.from || ""));
      fAction.appendChild(new Option(h.actionBy || "", h.actionBy || ""));
      fFrom.value = h.from || "";
      fAction.value = h.actionBy || "";
      fFrom.setAttribute("disabled","disabled");
      fAction.setAttribute("disabled","disabled");

      // To options
      const names = employeeNames();
      setSelectOptions(fTo, names, false);
      fTo.value = h.to || (names[0] || "");

      byId("handover-attachment").value = "";
      if (h.attachmentName && h.attachmentDataUrl){
        byId("attachment-info").textContent = `Current attachment: ${h.attachmentName}`;
      } else {
        byId("attachment-info").textContent = "No attachment";
      }

      const editable = canEditHandover(h);
      edit.handover.readOnly = !editable;

      titleEl.textContent = editable ? "Edit Handover" : "View Handover";
      setReadOnly(!editable);
      modals.handover.show();
    }

    onId("btn-add-handover", "click", openNew);
    onId("btn-add-handover-2", "click", openNew);
    form.addEventListener("submit", saveSubmit);

    // expose for table buttons
    window.__openHandover = openEdit;
  }

  function openHandover(id){ window.__openHandover?.(id); }

  // ===== Employees =====
  function initEmployees(){
    modals.employee = new bootstrap.Modal(byId("employee-modal"));

    function render(){
      const tbody = byId("employees-tbody");
      tbody.innerHTML = "";
      employees.forEach((e, i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${e.name}</td>
          <td>${e.role || ""}</td>
          <td>${e.email || ""}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary btn-emp-edit" data-i="${i}"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-danger btn-emp-del" data-i="${i}"><i class="bi bi-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll(".btn-emp-edit").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i = parseInt(btn.getAttribute("data-i"),10);
          openEdit(i);
        });
      });
      document.querySelectorAll(".btn-emp-del").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i = parseInt(btn.getAttribute("data-i"),10);
          const ok = confirm("Delete this employee?");
          if (!ok) return;
          const name = employees[i]?.name;
          // Prevent deleting if used in handovers or linked to account
          const used = handovers.some(h=>h.from===name||h.to===name||h.actionBy===name) || accounts.some(a=>a.employeeName===name);
          if (used) return alert("Cannot delete: this employee is referenced in handovers or accounts.");
          employees.splice(i,1);
          saveAll();
          refreshEmployeeSelects();
          render();
          applyFilters();
        });
      });
    }

    function openEdit(i){
      edit.employeeIndex = i;
      const e = employees[i];
      byId("emp-edit-name").value = e.name || "";
      byId("emp-edit-role").value = e.role || "";
      byId("emp-edit-email").value = e.email || "";
      modals.employee.show();
    }

    onId("employee-form","submit",(ev)=>{
      ev.preventDefault();
      const name = (byId("emp-name").value||"").trim();
      if (!name) return;
      if (employees.some(x => x.name.toLowerCase() === name.toLowerCase())) return alert("Employee already exists.");

      employees.push({
        name,
        role: (byId("emp-role").value||"").trim(),
        email:(byId("emp-email").value||"").trim()
      });
      saveAll();
      byId("emp-name").value = "";
      byId("emp-role").value = "";
      byId("emp-email").value = "";
      refreshEmployeeSelects();
      render();
    });

    onId("employee-edit-form","submit",(ev)=>{
      ev.preventDefault();
      const i = edit.employeeIndex;
      if (i === null || i === undefined) return;
      const oldName = employees[i]?.name;
      const name = (byId("emp-edit-name").value||"").trim();
      if (!name) return;

      // if name changed, update references
      if (oldName && oldName !== name){
        // Prevent conflict
        if (employees.some((x,idx)=> idx!==i && x.name.toLowerCase()===name.toLowerCase())) return alert("Name already exists.");

        handovers.forEach(h=>{
          if (h.from===oldName) h.from=name;
          if (h.to===oldName) h.to=name;
          if (h.actionBy===oldName) h.actionBy=name;
        });
        deleted.forEach(h=>{
          if (h.from===oldName) h.from=name;
          if (h.to===oldName) h.to=name;
          if (h.actionBy===oldName) h.actionBy=name;
        });
        accounts.forEach(a=>{
          if (a.employeeName===oldName) a.employeeName=name;
        });
      }

      employees[i] = { name, role:(byId("emp-edit-role").value||"").trim(), email:(byId("emp-edit-email").value||"").trim() };
      saveAll();
      refreshEmployeeSelects();
      modals.employee.hide();
      applyFilters();
      render();
    });

    window.__renderEmployees = render;
  }

  // ===== Accounts (Admin) =====
  function initAccounts(){
    modals.account = new bootstrap.Modal(byId("account-modal"));

    function render(){
      const tbody = byId("accounts-tbody");
      tbody.innerHTML = "";

      accounts.forEach((a,i)=>{
        const badge = (a.status||"Active")==="Disabled" ? "bg-secondary-subtle text-secondary" : "bg-success-subtle text-success";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${a.username}</td>
          <td>${a.employeeName || "-"}</td>
          <td>${a.role || "User"}</td>
          <td><span class="badge rounded-pill ${badge}">${a.status || "Active"}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-secondary btn-acc-edit" data-i="${i}"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-danger btn-acc-del" data-i="${i}"><i class="bi bi-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll(".btn-acc-edit").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i = parseInt(btn.getAttribute("data-i"),10);
          openEdit(i);
        });
      });

      document.querySelectorAll(".btn-acc-del").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const acc = getLoggedInAccount();
          if (!acc || acc.role !== "Admin") return alert("Admin only.");
          const i = parseInt(btn.getAttribute("data-i"),10);
          const target = accounts[i];
          if (!target) return;

          const ok = confirm(`Delete account "${target.username}" ?`);
          if (!ok) return;

          // Prevent deleting last admin
          const admins = accounts.filter(x => x.role === "Admin");
          if (target.role === "Admin" && admins.length === 1) return alert("Cannot delete the last Admin.");

          const session = getSession();
          accounts.splice(i,1);
          saveAll();
          render();

          if (session.username === target.username){
            setSession("");
            showLogin();
          }
        });
      });
    }

    function openNew(){
      const acc = getLoggedInAccount();
      if (!acc || acc.role !== "Admin") return alert("Admin only.");

      edit.account = { mode:false, index:null };
      byId("account-form").reset();
      refreshEmployeeSelects();
      byId("acc-status").value = "Active";
      byId("acc-password").value = "";
      modals.account.show();
    }

    function openEdit(i){
      const acc = getLoggedInAccount();
      if (!acc || acc.role !== "Admin") return alert("Admin only.");

      edit.account = { mode:true, index:i };
      refreshEmployeeSelects();

      const a = accounts[i];
      byId("acc-username").value = a.username;
      byId("acc-employee").value = a.employeeName || "";
      byId("acc-role").value = a.role || "User";
      byId("acc-status").value = a.status || "Active";
      byId("acc-password").value = "";
      modals.account.show();
    }

    onId("btn-add-account","click", openNew);

    onId("account-form","submit",(ev)=>{
      ev.preventDefault();
      const admin = getLoggedInAccount();
      if (!admin || admin.role !== "Admin") return alert("Admin only.");

      const username = (byId("acc-username").value||"").trim();
      const employeeName = (byId("acc-employee").value||"").trim();
      const role = byId("acc-role").value || "User";
      const status = byId("acc-status").value || "Active";
      const pw = (byId("acc-password").value||"").trim();

      if (!username) return;

      if (!edit.account.mode){
        if (accounts.some(x => x.username.toLowerCase() === username.toLowerCase())) return alert("Username already exists.");
        accounts.push({
          username,
          employeeName,
          role,
          status,
          password: pw || "1234"
        });
      } else {
        const i = edit.account.index;
        const cur = accounts[i];
        if (!cur) return;
        // username change uniqueness
        if (cur.username !== username && accounts.some(x => x.username.toLowerCase() === username.toLowerCase())) return alert("Username already exists.");
        accounts[i] = {
          ...cur,
          username,
          employeeName,
          role,
          status,
          password: pw ? pw : cur.password
        };
      }

      saveAll();
      modals.account.hide();
      render();
      updateUserBadges();
      applyFilters();
    });

    window.__renderAccounts = render;
  }

  // ===== Sidebar navigation =====
  function initNav(){
    document.querySelectorAll(".sidebar-nav .nav-link").forEach(a=>{
      a.addEventListener("click",(e)=>{
        e.preventDefault();
        const view = a.getAttribute("data-view");
        if (view) setActiveView(view);
      });
    });
  }

  // ===== JSON Import/Export (Admin) =====
  function initJsonIO(){
    onId("btn-export-json","click",()=>{
      const acc = getLoggedInAccount();
      if (!acc || acc.role !== "Admin") return alert("Admin only.");

      // Export without passwords (safer)
      const safeAccounts = accounts.map(a=>({
        username:a.username,
        employeeName:a.employeeName,
        role:a.role,
        status:a.status
      }));

      const data = {
        exportedAt: new Date().toISOString(),
        employees,
        accounts: safeAccounts,
        handovers,
        deleted
      };

      const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `warehouse-export-${nowDateISO()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    onId("btn-import-json","click",()=>{
      const acc = getLoggedInAccount();
      if (!acc || acc.role !== "Admin") return alert("Admin only.");
      byId("import-json-input").click();
    });

    byId("import-json-input").addEventListener("change", async (e)=>{
      const acc = getLoggedInAccount();
      if (!acc || acc.role !== "Admin") return;

      const file = e.target.files[0];
      if (!file) return;

      try{
        const text = await file.text();
        const data = JSON.parse(text);

        if (!data || !Array.isArray(data.employees) || !Array.isArray(data.accounts) || !Array.isArray(data.handovers) || !Array.isArray(data.deleted)){
          alert("Invalid JSON structure.");
          return;
        }

        const ok = confirm("This will REPLACE all current data in this browser.\nContinue?");
        if (!ok) return;

        // Restore (accounts imported without passwords => keep existing passwords if username matches)
        const oldPw = {};
        accounts.forEach(a => oldPw[a.username] = a.password);

        employees = data.employees;
        handovers = data.handovers;
        deleted   = data.deleted;

        accounts = data.accounts.map(a => ({
          ...a,
          password: oldPw[a.username] || "1234"
        }));

        saveAll();
        refreshEmployeeSelects();
        window.__renderEmployees?.();
        window.__renderAccounts?.();
        applyFilters();
        alert("Imported successfully.\nNote: passwords reset to 1234 if unknown.");
      } catch(err){
        console.error(err);
        alert("Failed to import JSON.");
      } finally {
        e.target.value = "";
      }
    });
  }

  // ===== Wipe All (Admin) =====
  function wipeAll(){
    const acc = getLoggedInAccount();
    if (!acc || acc.role !== "Admin") return alert("Admin only.");

    const ok1 = confirm("WARNING: This will delete ALL local data in this browser.\nContinue?");
    if (!ok1) return;

    const code = prompt('Type WIPE to confirm:');
    if ((code||"").trim().toUpperCase() !== "WIPE") return alert("Cancelled.");

    Object.values(STORE).forEach(k => localStorage.removeItem(k));
    location.reload();
  }

  // ===== Setup / Login =====
  function initSetupAndLogin(){
    // Setup form
    onId("setup-form","submit",(ev)=>{
      ev.preventDefault();
      const u = (byId("setup-username").value||"").trim();
      const p = (byId("setup-password").value||"").trim();
      const emp = (byId("setup-employee").value||"").trim();

      const err = byId("setup-error");
      err.style.display="none";

      if (!u || !p){
        err.textContent = "Username and password are required.";
        err.style.display="block";
        return;
      }

      if (accounts.length){
        err.textContent = "Setup is already completed.";
        err.style.display="block";
        return;
      }

      // Optional employee creation if provided
      if (emp){
        if (!employees.some(e => e.name.toLowerCase() === emp.toLowerCase())){
          employees.push({ name: emp, role: "Admin", email: "" });
        }
      }

      accounts.push({
        username: u,
        employeeName: emp || "",
        role: "Admin",
        status: "Active",
        password: p
      });

      saveAll();
      showLogin();
    });

    // Login form
    onId("login-form","submit",(ev)=>{
      ev.preventDefault();
      const u = (byId("login-username").value||"").trim();
      const p = (byId("login-password").value||"");

      const r = validateLogin(u,p);
      const err = byId("login-error");
      if (!r.ok){
        err.textContent = r.message;
        err.style.display="block";
        return;
      }
      err.style.display="none";
      setSession(r.account.username);

      showApp();
      updateUserBadges();
      refreshEmployeeSelects();
      window.__renderEmployees?.();
      window.__renderAccounts?.();

      setActiveView("dashboard");
      applyFilters();
    });
  }

  // ===== Logout =====
  function initLogout(){
    onId("btn-logout","click",()=>{
      setSession("");
      showLogin();
    });
  }

  // ===== Init =====
  document.addEventListener("DOMContentLoaded", ()=>{
    loadAll();

    // No defaults: if no accounts => setup page
    if (!accounts.length){
      showSetup();
    } else {
      // If session exists and user still valid => auto login
      const sess = getSession().username;
      const acc = accounts.find(a=>a.username===sess && (a.status||"Active")!=="Disabled");
      if (acc){
        showApp();
      } else {
        showLogin();
      }
    }

    // Bind global buttons
    onId("btn-reset-filters","click", resetFilters);
    onId("btn-export-excel","click", exportExcel);
    onId("btn-wipe-all","click", wipeAll);

    // Filters
    ["filter-from","filter-to","filter-status","filter-priority","filter-date-from","filter-date-to"]
      .forEach(id => onId(id,"change", applyFilters));
    onId("filter-search","input", applyFilters);

    // Navigation
    initNav();

    // Modules
    initEmployees();
    initAccounts();
    initHandoverModal();
    initJsonIO();
    initSetupAndLogin();
    initLogout();

    // Initial render when app visible
    if (byId("app-shell").style.display !== "none"){
      updateUserBadges();
      refreshEmployeeSelects();
      window.__renderEmployees?.();
      window.__renderAccounts?.();
      setActiveView("dashboard");
      applyFilters();
    }
  });

})();
</script>

</body>
</html>
